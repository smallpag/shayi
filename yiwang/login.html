<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="css/login.css">
	<title>注册登录</title>
</head>
<body onload="bg()">
	<div id="login_bg00"></div>
	<div class="login_bg2">
 		<div class="login_bg3"></div>
		<div class="login_div_box">
			<div class="logo_div">
				<img class="logo_img" onclick="location.href='index.html'" src="img/login/logoAndText.svg">
			</div>
			<div class="login_input_box">
				<div class="login_close">
					<img src="img/login/closeInput.svg" onclick="location.href='index.html'">
				</div>


				<section id="login_box">
					<div class="unameinput">
						<p id="unamep" class="unamep">请输入手机号或邮箱</p>
						<input type="text" id="unameinput" class="uname_input" name="uname" onfocus="inputfocus('unamep','unameline')">
						<div class="line" id="unameline"></div>
						<span class="inputtip" id="unametip">
							<span class="tip1">!</span>
							<span class="tip2"></span>
							<span id="usernamespan" class="tip3">您输入的不是一个手机号或邮箱</span>
						</span>
					</div>
					<div class="upwdinput">
						<p id="upwdp" class="upwdp">请输入密码</p>
						<input type="password" id="upwdinput" class="upwd_input" name="upwd" onfocus="inputfocus('upwdp','upwdline')">
						<div class="line" id="upwdline"></div>
						<span class="inputtip" id="upwdtip">
							<span class="tip1">!</span>
							<span class="tip2"></span>
							<span id="userpwdspan" class="tip3">登录密码不能为空</span>
						</span>
					</div>
					<p class="forgetupwd">忘记密码</p>
					<button  class="submit" onclick="loginajax()">登录</button>
					<p class="ptoregister">
						还没有账号 ?
						<span onclick="changetoregister()">请注册</span>
					</p>
					<div class="graylinebox">
						<span class="liner1"></span>
						<span class="huo">或</span>
						<span class="liner2"></span>
					</div>
					<div class="login_foot">
						<a href="" class="foota1"></a>
						<a href="" class="foota2"></a>
						<a href="" class="foota3"></a>
					</div>
				</section>

 				<section id="register_box"> 
					<div class="unameinput">
						<p id="unamep1" class="unamep">请输入手机号或邮箱</p>
						<input type="text" id="unameinput1" class="uname_input" name="uname" onfocus="inputfocus('unamep1','unameline1')">
						<div class="line" id="unameline1"></div>
						<span class="inputtip" id="unametip1">
							<span class="tip1">!</span>
							<span class="tip2"></span>
							<span id="usernamespan1" class="tip3">您输入的不是一个手机号或邮箱</span>
						</span>
					</div>


					<div class="code_box">
						<input type="text" id="writecode" class="writecode" placeholder="请输入验证码">
						<div id="v_container" class="createcode"></div>
						<span class="inputtip" id="imgcode">
							<span class="tip2"></span>
							<span id="imgcodespan" class="tip3">验证码输入错误或者为空</span>
						</span>
					</div>


					<div class="mail_box">
						<input type="text" id="mail_input" class="writecode" placeholder="短信验证码">
						<button class="getmailbutton" onclick="getmail()" >获取短信验证码</button>
						<span class="inputtip" id="mailcheckspan">
							<span class="tip2"></span>
							<span id="mailspan" class="tip3">短信验证码错误</span>
						</span>
					</div>
					<div class="upwdinput">
						<p id="upwdp1" class="upwdp">请输入6-16位密码</p>
						<input type="password" id="upwdinput1" class="upwd_input" name="upwd" onfocus="inputfocus('upwdp1','upwdline1')">
						<div class="line" id="upwdline1"></div>
						<span class="inputtip" id="upwdtip1">
							<span class="tip1">!</span>
							<span class="tip2"></span>
							<span id="userpwdspan1" class="tip3">登录密码不能为空</span>
						</span>
					</div>

					<button class="submit" onclick="loginajax1()">注册</button>
					<p class="ptoregister">
						已有账号？
						<span onclick="changetologin()">请登录</span>
					</p>


				</section>

			</div>
		</div>
	</div>
<script src="js/jquery.min.js"></script>
<script src="js/common.js"></script>
<script src="js/gVerify.js"></script>
<script>
	//背景图随机选择使用
	function bg(){
		var loginbg=$("login_bg00");
		var lgbg=[];
		lgbg[0]="img/login/loginbg1.jpg";
		lgbg[1]="img/login/loginbg2.jpg";
		lgbg[2]="img/login/loginbg3.jpg";
		lgbg[3]="img/login/loginbg4.jpg";
		lgbg[4]="img/login/loginbg5.jpg";
		lgbg[5]="img/login/loginbg6.jpg";
		var changebg=Math.round(Math.random()*5+1);
		loginbg.style.cssText="background-image:url("+lgbg[changebg]+");";
	}
	$("upwdinput").onkeydown=function(e){
		if(e.keyCode===13){
			loginajax();
		}
	}
	$("upwdinput1").onkeydown=function(e){
		if(e.keyCode===13){
			loginajax1();
		}
	}
	
	//input框点击事件
	function inputfocus(a,b){
		var unamep=$(a);
		unamep.style.cssText='top:-22px;font-size:12px;color:rgb(207,104,10);';
		var unameinput=$(b);
		unameinput.style.cssText='width:300px;';
	}
	//点击切换注册事件
	function changetoregister(){
		$("login_box").style.cssText="display:none;";
		$("register_box").style.cssText="display:block;";
	}
	//点击切换登录事件
	function changetologin(){
		$("login_box").style.cssText="display:block;";
		$("register_box").style.cssText="display:none;";
	}
	//登录提交按钮
	function loginajax(){
		var unamevalue=$("unameinput").value;
		var isornophone=/^0?1[3|4|5|7|8][0-9]\d{8}$/;
		var isornoemail=/^[-_A-Za-z0-9]+@([_A-Za-z0-9]+\.)+[A-Za-z0-9]{2,3}$/;
		var unamespantip=$("unametip");
		if(isornophone.test(unamevalue)||isornoemail.test(unamevalue)){
			unamespantip.style.cssText="display:none;";
			var upwdspantip=$("upwdtip");
			var upwdvalue=$("upwdinput").value;
			if(upwdvalue==""){
				$("userpwdspan").innerHTML="登录密码不能为空";
				upwdspantip.style.cssText="display:inline-block";
			}else{
				upwdspantip.style.cssText="display:none";
				checkunameajax();
			}
		}else{
			$("usernamespan").innerHTML="您输入的不是一个手机号或邮箱";
			unamespantip.style.cssText="display:inline-block;";
		}
	}
	//注册按钮
	function loginajax1(){
		var unamevalue=$("unameinput1").value;
		var isornophone=/^0?1[3|4|5|7|8][0-9]\d{8}$/;
		var isornoemail=/^[-_A-Za-z0-9]+@([_A-Za-z0-9]+\.)+[A-Za-z0-9]{2,3}$/;
		var unamespantip=$("unametip1");
		if(isornophone.test(unamevalue)||isornoemail.test(unamevalue)){
			unamespantip.style.cssText="display:none;";
			var upwdspantip=$("upwdtip1");
			var upwdvalue=$("upwdinput1").value;
			if(upwdvalue==""){
				$("userpwdspan1").innerHTML="登录密码不能为空";
				upwdspantip.style.cssText="display:inline-block";
			}else{
				upwdspantip.style.cssText="display:none";
				imgcode();
			}
		}else{
			$("usernamespan1").innerHTML="您输入的不是一个手机号或邮箱";
			unamespantip.style.cssText="display:inline-block;";
		}
	}
	//登录用户名异步验证
	function checkunameajax(){
		var unamespantip=$("unametip");
		var xhr=createxhr();
		xhr.onreadystatechange=function(){
			if(xhr.readyState==4&&xhr.status==200){
				var res=xhr.responseText;
				if(res=="0"){
					$("usernamespan").innerHTML="用户不存在";
					unamespantip.style.cssText="display:inline-block";
				}else{
					checkloginajax();
				}
			}
		}
		var uname=$("unameinput").value;
		xhr.open("get","php/checkuname.php?uname="+uname,true);
		xhr.send(null);
	}
	//注册用户名异步验证
	function checkunameajax1(){
		var unamespantip=$("unametip1");
		var xhr=createxhr();
		xhr.onreadystatechange=function(){
			if(xhr.readyState==4&&xhr.status==200){
				var res=xhr.responseText;
				if(res=="1"){
					$("usernamespan1").innerHTML="用户名已注册，请直接登录";
					unamespantip.style.cssText="display:inline-block";
				}else{
					unamespantip.style.cssText="display:none";
					registerajax();
				}
			}
		}
		var uname=$("unameinput1").value;
		xhr.open("get","php/checkuname.php?uname="+uname,true);
		xhr.send(null);
	}
	//检查登录异步验证
	function checkloginajax(){
		var upwdspantip=$("upwdtip");
		var xhr=createxhr();
			xhr.onreadystatechange=function(){
				if(xhr.readyState==4&&xhr.status==200){
					var res=xhr.responseText;
					if(res=="0"){
						$("userpwdspan").innerHTML="密码不正确";
						upwdspantip.style.cssText="display:inline-block";
					}else{
						var uid=parseInt(res);
						sessionStorage.setItem("uid",uid);
						alert("欢迎回来");
						history.back(-1);
					}
				}		
			}
			var uname=$("unameinput").value;
			var upwd=$("upwdinput").value;
			xhr.open("get","php/login.php?uname="+uname+"&upwd="+upwd,true);
			xhr.send(null);
	}
	//图片验证码验证
	function imgcode(){
        var res = verifyCode.validate(document.getElementById("writecode").value);
			console.log(res);
		if(res==true){
			$("imgcode").style.cssText="display:none";
			checkgetmail();
		}else{
			$("imgcodespan").innerHTML="验证码输入错误或者为空";
			$("imgcode").style.cssText="display:inline-block";
		}
	}
	//验证短信验证码是否为空
	function checkgetmail(){
		var ismail=/^0?[0-9]\d{5}$/;
		var mailinput=$("mail_input").value;
		if(ismail.test(mailinput)){
			checkunameajax1();
			$("mailcheckspan").style.cssText="display:none";
		}else{
			$("mailcheckspan").style.cssText="display:inline-block";
			$("mailspan").innerHTML="短信验证码错误";
		}
	}
	//注册异步验证
	function registerajax(){
		var upwdspantip=$("upwdtip1");
		var xhr=createxhr();
			xhr.onreadystatechange=function(){
				if(xhr.readyState==4&&xhr.status==200){
					var res=xhr.responseText;
					var json=JSON.parse(res);
					if(json.can=="1"){
						alert("注册成功！");
						sessionStorage.setItem("uid",json.data);
						location.href="index.html";
					}
				}		
			}
			var uname=$("unameinput1").value;
			var upwd=$("upwdinput1").value;
			xhr.open("get","php/register.php?uname="+uname+"&upwd="+upwd,true);
			xhr.send(null);
	}
	//input框点击变形事件
	function inputfocus(a,b){
		var unamep=$(a);
		unamep.style.cssText='top:-22px;font-size:12px;color:rgb(207,104,10);';
		var unameinput=$(b);
		unameinput.style.cssText='width:300px;';
	}
	//图形验证码自动生成事件
	var verifyCode = new GVerify("v_container");
	//获取短信验证码事件
	function getmail(){
		var num="";
		for(var i=0;i<6;i++){
			num+=Math.floor(Math.random()*10);
		}
		$("mail_input").value=num;
	}
</script>
</body>
</html>
